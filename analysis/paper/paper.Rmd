---
title: \textbf{Species and genus plant classification with NEON hyperspectral remote sensing data}

author:
  - Victoria Scholl\thanks{victoria.scholl@colorado.edu, Earth Lab and Geography Dept., University of Colorado, Boulder, CO 80303, USA}
  - Maxwell B. Joseph\thanks{maxwell.b.joseph@colorado.edu, Earth Lab, University of Colorado, Boulder, CO 80303, USA}

output:
  bookdown::pdf_document2:
    keep_tex: true
    toc: false
    includes:
      in_header: header.sty
bibliography: references.bib
csl: ecology.csl 
---

```{r setup, echo = FALSE}
library(bookdown)
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  comment = "#>",
  dpi = 300
)
library(knitr)
```

<!-- The actual document text starts here: -->

\linenumbers

\begin{abstract}
Abstract text here
\end{abstract}


# Introduction {-}
1
* motivation for work, why bother?
* unprecedented access to unique hyperspectral airborne imagery from NEON (cite)
  - acknowledge additional data to add info (lidar, rgb) (cite) 
  - how meaningful can the HS data alone be to predict species? accuracies? 
  - we expect there to be meaningful information in the HS data for species/genus
2 - knowledge gaps in lit/field?
  - how useful are HS data across many species, ecosystems, geographies? 
  - where is the most important information contained? which wavelengths most important for species discrimination? differ across sites? (cite) 
  - generally more site-specific studies? 
  - prediction of species vs genus? How much easier is genus? Or is this difficult too? (cite hierarchical taxonomic classification recent study)
3 - how we addressed the knowledge gaps
  - the need to generalize methods across locations? --> NEON
  - which wavelengths are most important
  - data harmonization across NEON sites (why are the wavelengths different? Ask NEON person?)
  
  
The National Ecological Observatory Network (NEON) is a valuable source of publicly available ecological data across the United States [@keller2008continental].
We have extracted all NEON AOP hyperspectral data for every mapped stem in NEON plots where field data and airborne remote sensing data were collected during the same year.

We used a machine learning approach to evaluate plant identification potential using the hyperspectral data at multiple taxonomic resolutions: species and genus levels. 

Species classification is an active research area [@scholl2020integrating]. 


# Background {-}

# Methods {-}

## NEON data {-}

The NEON project monitors diverse ecosystems at 81 sites across 20 domains, each with similar climate and ecological characteristics, across the United States.
The NEON data that we used for our study include both *in-situ* plant measurements and airborne remote sensing image data [@neonDataProducts].
The Woody Plant Vegetation Structure (data product code DP1.10098) includes individual plant locations along with species and genus observations that are collected every 1 to 3 years. 
The NEON Airborne Observation Platform (AOP) collects airborne remote sensing data regularly at NEON sites. 
There are three AOP payloads, each carrying three types of sensors: (1) a high-resolution digital camera to capture red, green, blue (RGB) true-color images, (2) a light detection and ranging (lidar) system to capture discrete and waveform lidar data with approximately 1-4 points/waveforms per square meter, and (3) a pushbroom-style AVIRIS next-gen NEON Imaging Spectrometer (NIS) to capture hyperspectral data. 
The hyperspectral data contains 426 narrow bands spanning the visible to shortwave infrared wavelengths, from 380 - 2500nm, and the image data products derived have a spatial resolution of 1m. The AOP flies at an altitude of 1000m above ground level and the flight season typically runs from May to October. 
We worked with the NIS-derived Spectrometer orthorectified surface directional reflectance mosaic (data product code DP3.30006). 


## Data cleaning and preparation {-}

We performed our analysis in R [@R] with packages including neonUtilities [@neonUtilities], geoNEON [@geoNEON], neonhs [@neonhs].
In June 2020, we extracted hyperspectral reflectance data for all individual mapped stems at NEON sites that had an AOP flyover during the same year as when *in-situ* measurements were collected. 
We only kept individuals with a "live" plant status (as opposed to other plant status classifications such as "dead", "standing dead", "downed", "insect/disease damaged", and "no longer qualifies").
This included spectral reflectance spectra for 5972 observations of individual plants. 
Some individuals had multiple observations across years. 
The individual plants were identified taxon ranks of kingdom, family, genus, species, and variety. 
Most of them were identified at the species rank.
We filtered the plants by taxonomic rank to retain only those identified at the genus, species, and variety ranks. 
We removed varieties from scientific names to label each individual spectrum with its respective genus and species (when available). 
There were 74 unique genus values, 113 unique species values, and 151 unique genus-species combinations.
The hyperspectral reflectance spectra extracted from the locations of the individual plants have different starting wavelengths:

```{r wavelengthTable, message = FALSE, echo = FALSE}
df <- data.frame(wavelength = c(347, 381, 382, 384),
                 number = c(94, 1220, 1733, 2922))

knitr::kable(x = df, 
             # set column names
             col.names = c("Starting wavelength [nm]",
                           "Number of spectra"),
             # center align text in the columns
             align = c("c", "c"),
             format = "simple")
```

Each series of wavelengths increments by 5nm from each starting wavelength to yield 426 spectral bands. 
These starting wavelengths vary depending on which AOP payload was used to collect the hyperspectral data.
The wavelength values also change slightly each year when the NEON AOP re-calibrates their payload sensors [@kampe2010advances]. 
Most of them started at 384nm, so we linearly interpolated each spectrum to have the same 426 bands starting at 384nm and ending at 2512nm with 5nm increments.
Spectra from the Pu'u Maka'ala Natural Area Reserve (PUUM) NEON site in Hawaii had a starting wavelength of 347nm.
This is because NEON sub-contracted the PUUM flights to the Global Airborne Observatory, which has a spectrometer with a different wavelength range compared to the NIS payloads *([how to cite?](https://www.neonscience.org/observatory/observatory-blog/remote-sensing-partnership-made-paradise))*. 
We filtered out any spectra with a starting wavelength of 347nm, since the interpolation would require too much unavailable data outside the available range.
We flagged "bad bands" from 1340-1445nm, 1790-1995nm, and greater than 2400nm so they could be excluded from later analysis.
These wavelength ranges feature noisy reflectance data due to high water absorption [@bajorski2011]. 

Next, we removed samples belonging to species and genus classes with few samples. 
We figured that a small sample size would lead to a poor representation in model training. 
From the initial collection of 151 unique scientific names identified at the genus or species level, 50 of them had at least 20 samples and were kept for the classification analysis (Figure \@ref(fig:fig-histSpecies)). 
We randomly assigned each spectrum to the training or validation sets, using an 80/20 split. All 50 scientific name labels were represented in each set. 

```{r taxonTable, message = FALSE, echo = FALSE}
df <- data.frame(taxonCode = c("ABBA", "ABLAL", "ACRU, ACRUR", "ACSAS, ACSA3", 
                               "AMLA", "ARTR2", "BELE", "BENE4"),
                 scientificName = c("Abies balsamea", 
                                    "Abies lasiocarpa",
                                    "Acer rubrum",
                                    "Acer saccharum", 
                                    "Amelanchier laevis",
                                    "Artemisia tridentata",
                                    "Betula lenta",
                                    "Betula neoalaskana"),
                 commonName = c("balsam fir", "subalpine fir", "red maple", "sugar maple",
                                "Allegheny serviceberry", "sagebrush", "sweet birch", "resin birch"),
                 count = c(47,117, 489, 79, 37, 494, 28, 35))

knitr::kable(x = df, 
             # set column names
             col.names = c("Taxon code",
                           "Scientific name",
                           "Common name",
                           "Number of spectra"),
             # center align text in the columns
             align = c("c", "c", "c", "c"),
             format = "simple")
```

After these data cleaning steps, we were left with reflectance data for 5266 individuals at sites across 14 of the NEON eco-climatic domains (Figure \@ref(fig:fig-studyArea)). 
There is a noticeable imbalance of data across space and time; some NEON domains and US states (such as Hawaii) are not represented in our analysis. 
Years that we found when both *in-situ* and AOP data were collected were 2017, 2018, and 2019. 
Note that covid-19 postponed NEON data collection as well as the AOP flight season during 2020. 
We assumed that plant locations did not change over time. 

Show the spectra for each scientific name class (Figure \@ref(fig:fig-plotSpectra)).


## Species and genus classification {-}

We trained a random forest (RF) classifier to predict species based on NEON hyperspectral reflectance data.
RF is a machine learning approach that utilizes an ensemble of decision trees and iterative subsets of the training data.
We performed hyperparameter optimization of ntree, the number of decision trees in the forest, and mtry, the number of variables randomly sampled at each node in the tree.
We used the optimal values of 27 for mtry and 1000 for ntree in our final RF model.
There were 49 species classes and 27 genus classes for each classification. 
We computed overall accuracy, confusion matrices, and variable importance plots. 

To evaluate genus classification accuracy, we followed the same step as described for species classiciation, but we used each spectrum's associated genus as each class label. 
We provide all of our code in a research compendium here:[https://github.com/vscholl/neonHScompendium](https://github.com/vscholl/neonHScompendium). 


# Results {-}

We report overall classification accuracy of the species and genus classification: 

```{r, message = FALSE, echo = FALSE}
library(knitr)

df <- data.frame(oa = c("Out-of-bag (OOB)", "Independent validation"),
                 species = c(54.6, 54.9),
                 genus = c(60.5, 60.0))

knitr::kable(x = df, 
             # set column names
             col.names = c("Overall Classification Accuracy [%]",
                           "Species",
                           "Genus"),
             # center align text in the columns
             align = c("c", "c", "c"),
             format = "simple")
```


Classification accuracy was higher at the genus level (60%) compared to the species level (55%). 

Confusion matrix for species classification (Figure \@ref(fig:fig-confMatSpecies)).

Confusion matrix for genus classification (Figure \@ref(fig:fig-confMatGenus)).

Variable importance for species and genus classifiers (Figure \@ref(fig:fig-varImp)).


# Discussion {-}

Restate findings at high level

How do our findings compare to other similar studies. Consistent? Differences? (cite IDTReeS) Other ranges of accuracy using NEON HS data? How many sites too? 

Potential limitations
  - class imbalance - we tried to filter based on # samples, but our model has then only seen common species and would be unable to identify rare ones
  - filtering shadows, non-vegetation pixels.... (cite a paper from last IDTReeS comp)
  
Future directions, next steps
  - targeted species/genus for increased sampling to improve representation in the data set?
   - more advanced models. ML DL
   - RF treats each feature as independent
   - spectra are sequences of wavelengths - explore DL methods for sequences (i.e. recurrent neural networks)
   - hierarchical taxonomic approach - borrow information from closely related species (i.e. common and rare species > use common species observations)
   - (cite our other paper) intelligent crown geometry processing 
   - (ben weinstein) tree crown detection - extract multiple pixels per individual using rectangular crown boundaries
   - herbarium / hyperspectral data measurements at other scales. handheld spectrometer. other spectral libraries. 
   - combine HS with RGB, lidar
   
We conclude that HS data allow you to get __ accuracy
Hopes for outcomes 


# Appendix / Supplement ideas {-}

- Species histogram to show which ones were excluded for few # samples 
- Wavelength interpolation figures? 

# Acknowledgements {-}

Max has cool ideas and knows many R tricks


\clearpage

# References {-}

<div id="refs"></div>

\newpage

\clearpage 

# Figure legends {-}

## Figure 1 {-}

Map to illustrate the NEON sites and domains with data that we used in this study.

## Figure 2 {-}

Histogram showing which scientific names have at least 20 samples to be included in the classification analysis. Note that the "Larix sp." individuals are classified at the genus level. 

## Figure 3 {-}

Visualizing the extracted hyperspectral reflectance spectra for each of the 50 genus and species classes that we used in our classifications. 

## Figure 4 {-}

Confusion matrix for the species classifier. True and predicted species labels are shown here for each sample in the validation set. Counts along the diagonal represent correct species predictions. Counts outside of the diagonal represent incorrect species predictions. Each cell in the matrix is colored based on the number of counts to ease interpretation. Low counts are white and high counts are blue, with a gradient in between. Counts of zero are shown with a gray font color, to make non-zero counts (shown with a black font color) easier to identify.

## Figure 5 {-}

Confusion matrix for the genus classifier. True and predicted genus labels are shown here for each sample in the validation set. Counts along the diagonal represent correct genus predictions. Counts outside of the diagonal represent incorrect genus predictions. Each cell in the matrix is colored based on the number of counts to ease interpretation. Low counts are white and high counts are orange, with a gradient in between. Counts of zero are shown with a gray font color, to make non-zero counts (shown with a black font color) easier to identify.

## Figure 6 {-}

Variable importance plots for the species and genus classification. We used hyperspectral reflectance band values as descriptive features for each classifier. The Mean Decrease in Accuracy (MDA) importance metric value is plotted for each hyperspectral band. Each importance bar is colored based on importance, with low importance as white and follows a gradient to high importance as blue (for species variable importance) or orange (for genus variable importance).




# Figures {-}

## Figure 1 {-}

```{r fig-studyArea, fig.cap ="Map", echo=FALSE,  out.width = "450px", message = FALSE, warning=FALSE}
library(here)
knitr::include_graphics(here::here("analysis", "figures", "study_area.pdf"))
```

\clearpage

## Figure 2 {-}

```{r fig-histSpecies, fig.cap ="Histogram", echo=FALSE,  out.width = "450px", message = FALSE, warning=FALSE}
library(here)
knitr::include_graphics(here::here("analysis","figures", "hist_samples_per_species.pdf"))
```

\clearpage

## Figure 3 {-}

```{r fig-plotSpectra, fig.cap ="Spectra", echo=FALSE,  out.width = "450px", message = FALSE, warning=FALSE}
library(here)
knitr::include_graphics(here::here("analysis","figures", "spectra_per_species.pdf"))
```

\clearpage

## Figure 4 {-}

```{r fig-confMatSpecies, fig.cap ="Confusion matrix for species classification", echo=FALSE,  out.width = "450px", message = FALSE, warning=FALSE}
library(here)
knitr::include_graphics(here::here("analysis","figures", "confMat_species_valid.pdf"))
```

\clearpage

## Figure 5 {-}

```{r fig-confMatGenus, fig.cap ="Confusion matrix for genus classification", echo=FALSE,  out.width = "450px", message = FALSE, warning=FALSE}
library(here)
knitr::include_graphics(here::here("analysis","figures", "confMat_genus_valid.pdf"))
```

\clearpage

## Figure 6 {-}

```{r fig-varImp, fig.cap ="Variable importance", echo=FALSE,  out.width = "450px", message = FALSE, warning=FALSE}
library(here)
knitr::include_graphics(here::here("analysis","figures", "varImp.pdf"))
```

\clearpage
