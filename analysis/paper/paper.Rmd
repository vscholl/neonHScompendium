---
title: \textbf{Species and genus plant classification with NEON hyperspectral remote sensing data}

author:
  - Victoria Scholl\thanks{victoria.scholl@colorado.edu, Earth Lab and Geography Dept., University of Colorado, Boulder, CO 80303, USA}
  - Maxwell B. Joseph\thanks{maxwell.b.joseph@colorado.edu, Earth Lab, University of Colorado, Boulder, CO 80303, USA}

output:
  bookdown::pdf_document2:
    keep_tex: true
    toc: false
    includes:
      in_header: header.sty
bibliography: references.bib
csl: ecology.csl 
---

```{r setup, echo = FALSE}
library(bookdown)
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  comment = "#>",
  dpi = 300
)
```

<!-- The actual document text starts here: -->

\linenumbers

\begin{abstract}
Abstract text here
\end{abstract}

```{r, results='hide', message=FALSE, include=FALSE}
# Extract hyperspectral reflectance data for each individual plant
#R/spectral-lib.Rmd
# Run the main analysis
```

# Introduction {-}

1
* motivation for work, why bother?
* unprecedented access to unique hyperspectral airborne imagery from NEON (cite)
  - acknowledge additional data to add info (lidar, rgb) (cite) 
  - how meaningful can the HS data alone be to predict species? accuracies? 
  - we expect there to be meaningful information in the HS data for species/genus
2 - knowledge gaps in lit/field?
  - how useful are HS data across many species, ecosystems, geographies? 
  - where is the most important information contained? which wavelengths most important for species discrimination? differ across sites? (cite) 
  - generally more site-specific studies? 
  - prediction of species vs genus? How much easier is genus? Or is this difficult too? (cite hierarchical taxonomic classification recent study)
3 - how we addressed the knowledge gaps
  - the need to generalize methods across locations? --> NEON
  - which wavelengths are most important
  - data harmonization across NEON sites (why are the wavelengths different? Ask NEON person?)


The National Ecological Observatory Network (NEON) is a valuable source of publicly available ecological data across the United States [@keller2008continental].
We have extracted all NEON AOP hyperspectral data for every mapped stem in NEON plots where field data and airborne remote sensing data were collected during the same year.

We used a machine learning approach to evaluate plant identification potential using the hyperspectral data at multiple taxonomic resolutions: species and genus levels. 

Species classification is an active research area [@scholl2020integrating]. 

# Background {-}


# Methods {-}

## NEON data {-}

The NEON project monitors ecosystems at 20 domains, eaach with similar climate and ecological characteristics, across the United States.
The NEON data that we used for our study include both *in-situ* plant measurements and airborne remote sensing image data [@neonDataProducts].
The Woody Plant Vegetation Structure (data product code DP1.10098) includes individual plant locations along with species and genus observations that are collected every 1 to 3 years. 
The NEON Airborne Observation Platform (AOP) collects airborne remote sensing data regularly at NEON sites. 
There are three AOP payloads, each carrying three types of sensors: (1) a high-resolution digital camera to capture red, green, blue (RGB) true-color images, (2) a light detection and ranging (lidar) system to capture discrete and waveform lidar data with approximately 1-4 points/waveforms per square meter, and (3) a pushbroom-style imaging spectrometer (AVIRIS next-gen) to capture hyperspectral data. 
The hyperspectral data contains 426 narrow bands spanning the visible to shortwave infrared wavelengths, from 380 - 2500nm, and the image data products derived have a spatial resolution of 1m. The AOP flies at an altitude of 1000m above ground level and the flight season typically runs from May to October. 

We worked with the Spectrometer orthorectified surface directional reflectance mosaic (data product code DP3.30006). 


## Data cleaning and preparation {-}

We performed our analysis in R [@R] with packages including neonUtilities [@neonUtilities], geoNEON [@geoNEON], neonhs [@neonhs].
In June 2020, we extracted hyperspectral reflectance data for all mapped stems at NEON sites that had an AOP flyover during the same year as when *in-situ* measurements were collected. 
This included spectral reflectance spectra for 5972 observations of individual plants. 
Some individuals had multiple observations across years. 
The individual plants were identified taxon ranks of kingdom, family, genus, species, and variety. 
Most of them were identified at the species rank.
We filtered the plants by taxonomic rank to retain only those identified at the genus, species, and variety ranks. 
Varities were removed to focus on genus and species identifications. 
There were 74 unique genus values, 118 unique species values, and 151 unique genus-species combinations.

The hyperspectral reflectance spectra extracted from the locations of the individual plants 

```{r, message = FALSE}
library(knitr)

df <- data.frame(wavelength = c(347, 381, 382, 384),
                 number = c(94, 1220, 1733, 2922))

kable(df)
```


**? Filtered taxonomic levels, labels species & genus**
Wavelength interpolation - filtered out the PUUM site in Hawaii because of wavelengths
Filtering based on # samples
Train/validate split 80/20

**Figure - histogram of species counts, show which ones were used to train**
**Figure - cleaned data, make it legible**

After the data cleaning steps, we were left with reflectance data for *____* individuals at sites across 14 of the NEON eco-climatic domains (Figure \@ref(fig:fig-studyArea)). 
There is a noticeable imbalance of data across space and time; some NEON domains and US states (such as Hawaii) are not represented in our analysis. 
Years that we found when both *in-situ* and AOP data were collected were 2017, 2018, and 2019. 
Note that covid-19 postponed NEON data collection as well as the AOP flight season during 2020. 
We assumed that plant locations did not change over time. 

**Filtered plants to keep only "live" ones**
**Mask created for water absorption bands (cite)**

We provide all of our code in a research compendium here:[https://github.com/vscholl/neonHScompendium](https://github.com/vscholl/neonHScompendium). 







## Species classification {-}

Random forest classifier
Hyperparameter optimization (mtry, ntree)
Overall accuracy, confusion matrices, variable importance

## Genus classification {-}

Same setup as species classification, but used the genus as each class label. 

# Results {-}

Classification accuracy was higher at the genus level (60%) compared to the species level (55%) 

Figure - confusion matrices
Figure - variable importance vs wavelength
Figure - multi-year observations of individual plants? 


<!-- Here's some example analysis code: -->

```{r get-data, eval = FALSE}
# Note the path that we need to use to access our data files when rendering this document
my_data <- read.csv(here::here('analysis/data/raw_data/my_csv_file.csv'))
```

```{r demo-inline-code}
x <- round(pi, 2)
```

Here is an example of inline code `r x` in the middle of a sentence. 

# Discussion {-}

Restate findings at high level

How do our findings compare to other similar studies. Consistent? Differences? (cite IDTReeS) Other ranges of accuracy using NEON HS data? How many sites too? 

Potential limitations
  - class imbalance - we tried to filter based on # samples, but our model has then only seen common species and would be unable to identify rare ones
  - filtering shadows, non-vegetation pixels.... (cite a paper from last IDTReeS comp)
  
Future directions, next steps
  - targeted species/genus for increased sampling to improve representation in the data set?
   - more advanced models. ML DL
   - RF treats each feature as independent
   - spectra are sequences of wavelengths - explore DL methods for sequences (i.e. recurrent neural networks)
   - hierarchical taxonomic approach - borrow information from closely related species (i.e. common and rare species > use common species observations)
   - (cite our other paper) intelligent crown geometry processing 
   - (ben weinstein) tree crown detection - extract multiple pixels per individual using rectangular crown boundaries
   - herbarium / hyperspectral data measurements at other scales. handheld spectrometer. other spectral libraries. 
   - combine HS with RGB, lidar
   
We conclude that HS data allow you to get __ accuracy
Hopes for outcomes 


# Appendix / Supplement ideas {-}

- Species histogram to show which ones were excluded for few # samples 
- Wavelength interpolation figures? 

# Acknowledgements {-}

Max has cool ideas and knows many R tricks


<!-- The following line inserts a page break  -->

\clearpage

# References {-}

<div id="refs"></div>

\newpage

\clearpage 

# Figure legends {-}

## Figure 1 {-}

Map to illustrate the NEON sites and domains with data that we used in this study.

## Figure 2 {-}

It ain't much...

# Figures {-}

## Figure 1 {-}

```{r fig-studyArea, fig.cap ="Study Area", echo=FALSE,  out.width = "450px", message = FALSE, warning=FALSE}
library(here)
knitr::include_graphics(here::here("analysis", "figures", "study_area.pdf"))
```

\clearpage

## Figure 2 {-}


\clearpage

## Figure 3 {-}



\clearpage

